<!DOCTYPE html>
<html>
<head>
    <title>Real-time Test - Fixed Version</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 20px; 
            background: #1a1a1a;
            color: #fff;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #10b981; }
        .container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px;
        }
        .panel {
            background: #262626;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #404040;
        }
        .status { 
            padding: 10px 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: 500;
            display: inline-block;
        }
        .connected { 
            background: #065f46; 
            color: #10b981; 
            border: 1px solid #10b981;
        }
        .error { 
            background: #7f1d1d; 
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        .pending {
            background: #78350f;
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        .log { 
            padding: 8px 10px; 
            margin: 4px 0; 
            background: #1a1a1a; 
            font-size: 13px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            border-left: 3px solid #404040;
        }
        .log.error { 
            border-left-color: #ef4444;
            color: #fca5a5;
        }
        .log.success { 
            border-left-color: #10b981;
            color: #86efac;
        }
        .log.warning {
            border-left-color: #fbbf24;
            color: #fde047;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #059669;
        }
        button:disabled {
            background: #404040;
            cursor: not-allowed;
        }
        .button-group {
            margin: 20px 0;
        }
        #messages {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .stat {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
        }
        .stat-label {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Supabase Real-time Test - Fixed Version</h1>
    
    <div id="status" class="status pending">üîå Initializing...</div>
    
    <div class="container">
        <div class="panel">
            <h3>üìä Test Controls</h3>
            
            <div class="button-group">
                <button onclick="testConnection()">Test Connection</button>
                <button onclick="enableRealtime()">Enable Realtime (SQL)</button>
            </div>
            
            <div class="button-group">
                <button onclick="testInsert()">Insert Item</button>
                <button onclick="testUpdate()">Update Item</button>
                <button onclick="testDelete()">Delete Test Items</button>
            </div>
            
            <div class="button-group">
                <button onclick="testColumnChange()">Change Column</button>
                <button onclick="testAssignment()">Test Assignment</button>
            </div>
            
            <div class="button-group">
                <button onclick="clearLogs()">Clear Logs</button>
                <button onclick="reconnect()">Reconnect</button>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="itemCount">0</div>
                    <div class="stat-label">Item Changes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="columnCount">0</div>
                    <div class="stat-label">Column Changes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="errorCount">0</div>
                    <div class="stat-label">Errors</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h3>üìù Live Logs</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://loshvtjahbhenrfgpvge.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxvc2h2dGphaGJoZW5yZmdwdmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODcxNjMsImV4cCI6MjA3MTU2MzE2M30.cFR1LAnH9wwYeWDstl2rSXBSeJUu7fiMqbwlvUV8ySk";

        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_KEY);

        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        let testItemId = null;
        let testColumnId = null;
        let testProjectId = '00000000-0000-0000-0000-000000000001';
        let channel = null;
        
        // Counters
        let itemChangeCount = 0;
        let columnChangeCount = 0;
        let errorCount = 0;

        function updateStats() {
            document.getElementById('itemCount').textContent = itemChangeCount;
            document.getElementById('columnCount').textContent = columnChangeCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        function log(message, type = 'info') {
            const p = document.createElement('div');
            p.className = `log ${type}`;
            const time = new Date().toLocaleTimeString();
            p.innerHTML = `<strong>${time}</strong> ${message}`;
            messagesDiv.insertBefore(p, messagesDiv.firstChild);
            
            // Auto-scroll to latest
            messagesDiv.scrollTop = 0;
            
            // Keep only last 100 logs
            while (messagesDiv.children.length > 100) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            messagesDiv.innerHTML = '';
            itemChangeCount = 0;
            columnChangeCount = 0;
            errorCount = 0;
            updateStats();
            log('Logs cleared', 'info');
        }

        async function testConnection() {
            log('Testing database connection...', 'info');
            
            try {
                const { data, error } = await client
                    .from('projects')
                    .select('id, name')
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    log(`‚úÖ Database connected! Found project: ${data[0].name}`, 'success');
                } else {
                    log('‚ö†Ô∏è Database connected but no projects found', 'warning');
                }
            } catch (error) {
                log(`‚ùå Database connection failed: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            }
        }

        async function enableRealtime() {
            log('Attempting to enable realtime via SQL...', 'info');
            
            const sql = `
                -- Drop existing publication if it exists
                DROP PUBLICATION IF EXISTS supabase_realtime CASCADE;
                
                -- Create publication for specific tables
                CREATE PUBLICATION supabase_realtime FOR TABLE 
                  public.items,
                  public.columns,
                  public.projects,
                  public.item_assignments,
                  public.profiles,
                  public.custom_fields,
                  public.item_field_values;
                
                -- Set replica identity to FULL
                ALTER TABLE public.items REPLICA IDENTITY FULL;
                ALTER TABLE public.columns REPLICA IDENTITY FULL;
            `;
            
            log('‚ö†Ô∏è Please run the SQL in enable_realtime.sql file in Supabase SQL Editor', 'warning');
            log('Location: supabase/migrations/enable_realtime.sql', 'info');
        }

        async function initialize() {
            log('üöÄ Initializing test environment...', 'info');
            
            // Get a test column
            const { data: columns, error: colError } = await client
                .from('columns')
                .select('id, name, project_id')
                .eq('project_id', testProjectId)
                .limit(1);
            
            if (colError) {
                log(`Error getting columns: ${colError.message}`, 'error');
                errorCount++;
                updateStats();
                return;
            }
            
            if (columns && columns.length > 0) {
                testColumnId = columns[0].id;
                log(`üìä Using column: ${columns[0].name} (${testColumnId})`, 'success');
            } else {
                log('‚ö†Ô∏è No columns found for test project', 'warning');
            }

            // Get an existing item to test updates
            const { data: items, error: itemError } = await client
                .from('items')
                .select('id, name')
                .limit(1);
            
            if (items && items.length > 0) {
                testItemId = items[0].id;
                log(`üì¶ Found test item: ${items[0].name} (${testItemId})`, 'success');
            }
            
            setupRealtimeSubscription();
        }

        function setupRealtimeSubscription() {
            // Clean up existing channel
            if (channel) {
                log('üßπ Cleaning up existing channel', 'info');
                client.removeChannel(channel);
            }

            const channelName = `test-fixed-${Date.now()}`;
            log(`üì° Creating channel: ${channelName}`, 'info');
            
            channel = client
                .channel(channelName)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'items' },
                    (payload) => {
                        itemChangeCount++;
                        updateStats();
                        const details = payload.new || payload.old;
                        log(`üì¶ Item ${payload.eventType}: ${details?.name || 'unknown'} (ID: ${details?.id})`, 'success');
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'columns' },
                    (payload) => {
                        columnChangeCount++;
                        updateStats();
                        const details = payload.new || payload.old;
                        log(`üìä Column ${payload.eventType}: ${details?.name || 'unknown'}`, 'success');
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'item_assignments' },
                    (payload) => {
                        itemChangeCount++;
                        updateStats();
                        log(`üë• Assignment ${payload.eventType}`, 'success');
                    }
                )
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        statusDiv.textContent = '‚úÖ Connected to real-time';
                        statusDiv.className = 'status connected';
                        log('üéâ Successfully subscribed to real-time updates!', 'success');
                    } else if (status === 'CHANNEL_ERROR') {
                        statusDiv.textContent = '‚ùå Channel error - check console';
                        statusDiv.className = 'status error';
                        log(`Channel error: ${err?.message || 'Unknown error'}`, 'error');
                        errorCount++;
                        updateStats();
                    } else if (status === 'TIMED_OUT') {
                        statusDiv.textContent = '‚è±Ô∏è Connection timeout';
                        statusDiv.className = 'status error';
                        log('Connection timed out - retrying...', 'warning');
                    } else {
                        statusDiv.textContent = `üì° ${status}`;
                        statusDiv.className = 'status pending';
                        log(`Subscription status: ${status}`, 'info');
                    }
                });
        }

        async function testInsert() {
            if (!testColumnId) {
                log('‚ùå No test column available', 'error');
                return;
            }

            const testName = `Test Item ${Date.now()}`;
            log(`‚ûï Inserting item: ${testName}`, 'info');
            
            const { data, error } = await client
                .from('items')
                .insert({
                    name: testName,
                    column_id: testColumnId,
                    position: 999,
                    actual_time: 0
                })
                .select()
                .single();
            
            if (error) {
                log(`Insert error: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            } else {
                log(`‚úÖ Inserted successfully! ID: ${data.id}`, 'success');
                testItemId = data.id;
            }
        }

        async function testUpdate() {
            if (!testItemId) {
                log('‚ùå No test item available', 'error');
                return;
            }

            const newName = `Updated ${Date.now()}`;
            log(`‚úèÔ∏è Updating item ${testItemId} to: ${newName}`, 'info');
            
            const { error } = await client
                .from('items')
                .update({ name: newName })
                .eq('id', testItemId);
            
            if (error) {
                log(`Update error: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            } else {
                log('‚úÖ Updated successfully!', 'success');
            }
        }

        async function testDelete() {
            log('üóëÔ∏è Deleting all test items...', 'info');
            
            const { error } = await client
                .from('items')
                .delete()
                .like('name', 'Test Item%');
            
            if (error) {
                log(`Delete error: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            } else {
                log('‚úÖ Test items deleted!', 'success');
                testItemId = null;
            }
        }

        async function testColumnChange() {
            if (!testColumnId) {
                log('‚ùå No test column available', 'error');
                return;
            }

            const newName = `Column ${Date.now()}`;
            log(`‚úèÔ∏è Updating column name to: ${newName}`, 'info');
            
            const { error } = await client
                .from('columns')
                .update({ name: newName })
                .eq('id', testColumnId);
            
            if (error) {
                log(`Column update error: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            } else {
                log('‚úÖ Column updated!', 'success');
            }
        }

        async function testAssignment() {
            if (!testItemId) {
                log('‚ùå No test item available', 'error');
                return;
            }

            // Get current user
            const { data: { user }, error: userError } = await client.auth.getUser();
            
            if (userError || !user) {
                log('‚ùå Not authenticated', 'error');
                return;
            }

            log(`üë• Assigning item to user: ${user.email}`, 'info');
            
            const { error } = await client
                .from('item_assignments')
                .insert({
                    item_id: testItemId,
                    user_id: user.id
                })
                .single();
            
            if (error) {
                if (error.code === '23505') {
                    log('Assignment already exists', 'warning');
                } else {
                    log(`Assignment error: ${error.message}`, 'error');
                    errorCount++;
                    updateStats();
                }
            } else {
                log('‚úÖ Assignment created!', 'success');
            }
        }

        function reconnect() {
            log('üîÑ Reconnecting...', 'info');
            setupRealtimeSubscription();
        }

        // Initialize on load
        initialize();

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (channel) {
                client.removeChannel(channel);
            }
        });
    </script>
</body>
</html>